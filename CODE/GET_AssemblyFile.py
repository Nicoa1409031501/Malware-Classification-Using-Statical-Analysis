import os
import glob
import r2pipe
import openpyxl

import pandas as pd
import json
from pathlib import Path

def SettingDirectory(dir:str):
    #定位資料集以及專案位置

    #Datasets directory.
    Datasets_dir = Path(dir)
    # Project dir directory.
    Project_dir = Path("/home/cape/Malware-Classification-Using-Statical-Analysis")


    #確認所需資料夾是否存在,創建檔案資料夾
    List_Folder_Datasets=['png','Sample','Asm_r2','Asm_objdump','Library','Section_Attributions','CSV','NPZ','JOBLIB','TXT','Reports'] 

    for Folder in List_Folder_Datasets:
        if not Path(Datasets_dir).joinpath(Folder).exists():
            Path(Datasets_dir).joinpath(Folder).mkdir()
        globals()[Folder +"_dir"]=Path(Datasets_dir).joinpath(Folder)
        print('%-20s'%Folder,"Folder exists:",'[%-3s]'%("yes") if (Path(Datasets_dir).joinpath(Folder).exists())else "no")


    #創建id列表,一律只記錄hash值
   #創建檔案列表,紀錄檔案名稱

    List_ids=[]
    List_files=[]
    Dict_id2file={}
    Dict_file2id={}
    for filelist in Path(Datasets_dir).joinpath("Sample").glob("*"):
        #print(filelist.name.split('.',)[0])
        List_ids.append(filelist.name.split('.',)[0])
        List_files.append(filelist.name)
        Dict_file2id[filelist.name]=filelist.name.split('.',)[0]
        Dict_id2file[filelist.name.split('.',)[0]]=filelist.name
 
        
    return List_ids,List_files,Dict_file2id,Dict_id2file
List_ids,List_files,Dict_file2id,Dict_id2file=SettingDirectory("/home/cape/Documents/dike_dataset")

for i in Path(Sample_dir).glob("*?*"):
    filename=os.path.basename(i)
    r=r2pipe.open(str(i))
    r.cmd('aaaa')
    r.cmd('iS')
    r.cmd('afl')
    assembly_code_section=r.cmd('afl').splitlines(True)
    with Path(Arm_r2_dir).joinpath(ilename+'.asm').open('w') as file_write:
        for j in assembly_code_section:
            section_address=j.split(' ',2)[0]
            r.cmd(section_address)
            assembly_code=r.cmd('pdr')
            file_write.write(assembly_code)


