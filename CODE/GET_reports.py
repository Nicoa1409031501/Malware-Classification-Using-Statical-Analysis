import requests
import os
import glob
from pathlib import Path
#Datasets directory.
Datasets_dir = Path("/home/cape/Documents/dike_dataset")
# Project dir directory.
Project_dir = Path("/home/cape/Malware-Classification-Using-Statical-Analysis")
# Reports dir directory.
Reports_dir = Path(Datasets_dir).joinpath("Reports")
List_Folder_Datasets=['png','Sample','Asm_r2','Asm_objdump','Library','Section_Attributions','CSV','NPZ','JOBLIB','TXT','Reports'] 
for Folder in List_Folder_Datasets:
    if not Path(Datasets_dir).joinpath(Folder).exists():
        Path(Datasets_dir).joinpath(Folder).mkdir()
    locals()[Folder +"_dir"]=Path(Datasets_dir).joinpath(Folder)

# VirusTotal API request parameters
VT_url = "https://www.virustotal.com/api/v3/files/"
api_key = "a0224609fc27608dc1aec1a8f05eedbdde628ac244b2fd34551f58a8de0d52a0"

headers = {
    "accept": "application/json",
    "x-apikey": api_key
}

# VirusTotal report(JSON) location
ID_list = []
failed_list = []

# Sample ID(SHA256) txt file location
fileID_path = Path(TXT_dir).joinpath("ALL_name.txt")


# Get report from virustotal API
def GetReport(fileID: str):
    # Get report from virustotal
    requested_file = VT_url + fileID
    response = requests.get(requested_file, headers=headers)

    # Output Result
    f = Path(Reports_dir).joinpath(fileID + ".json").open('w+')
    f.write(response.text)
    f.close()  

# Main Process
def main(fileList: list):
    f_num = 1
    
    
    for fileID1 in fileList:
        # INFO
        print(f'Processing NO.{f_num}')
        # Get virustotal report
        print("Getting report from virustotal...")
        GetReport(fileID1)
        print(f'File {fileID1} finished.')
        print(f'============================================\n')
        '''
        if f_num == 10000:
             break
        f_num += 1
        '''
    
    # Output failed list
    with Path(Reports_dir).joinpath("failed_files.txt").open(mode = "w", encoding  = "UTF-8") as failed_txt:
        for item in failed_list:
            failed_txt.write(f'{item}\n')


### Starting Process

# Get all sample ID, stored in ID_list
with open(fileID_path, mode = "r", encoding = "UTF-8") as IDtxt:
    for line in IDtxt:
        line = line.strip()

        """
        # Skip if file report exists
        if os.path.isfile(f'{VT_folder_path_Bazaar}{line}.json'):
            # print(f'Skipping file {line}')
            # print(f'==============================\n')
            None
        else:
            ID_list.append(line)
        """
        if not Path(Reports_dir).joinpath(Path(Reports_dir).joinpath(line + ".json")).exists():
            ID_list.append(line)
            
print(ID_list)

# Get virustotal reports, stored in E:\no6\Reports
main(ID_list)



