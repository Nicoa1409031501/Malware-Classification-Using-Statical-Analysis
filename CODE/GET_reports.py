import requests
import os
import glob

# VirusTotal API request parameters
VT_url = "https://www.virustotal.com/api/v3/files/"
api_key = "a0224609fc27608dc1aec1a8f05eedbdde628ac244b2fd34551f58a8de0d52a0"

headers = {
    "accept": "application/json",
    "x-apikey": api_key
}

# VirusTotal report(JSON) location
VT_folder_path = "/media/cape/12TB_HDD/Reports/"
VT_folder_path_Dike = "/media/cape/12TB_HDD/Reports/Reports_Dike/"
VT_folder_path_Mamba = "/media/cape/12TB_HDD/Reports/Reports_Mamba/"
VT_folder_path_Malimg = "/media/cape/12TB_HDD/Reports/Reports_Malimg/"
VT_folder_path_Bazaar = "/media/cape/12TB_HDD/Reports/Reports_Bazaar/"
ID_list = []
failed_list = []

# Sample ID(SHA256) txt file location
fileID_path = "/home/cape/Documents/Code/ALL_name.txt"


# Get report from virustotal API
def GetReport(fileID: str):
    # Get report from virustotal
    requested_file = VT_url + fileID
    response = requests.get(requested_file, headers=headers)

    # Output Result
    file_path = VT_folder_path_Bazaar + fileID + ".json"
    f = open(file_path, 'w+')
    f.write(response.text)
    f.close()  

# Main Process
def main(fileList: list):
    f_num = 1
    
    for fileID1 in fileList:
        # INFO
        print(f'Processing NO.{f_num}')
        
        '''
        # If input length is not 64 then append to failed lists
        if len(fileID1) != 64:
            print("Invalid Input\nInput SHA256: ", end = "")
            print(f'============================================\n')
            failed_list.append(fileID1)
            continue
            '''
        # Get virustotal report
        print("Getting report from virustotal...")
        GetReport(fileID1)
        print(f'File {fileID1} finished.')
        print(f'============================================\n')

        if f_num == 10000:
             break
        f_num += 1
    
    # Output failed list
    with open(VT_folder_path_Bazaar + "failed_files.txt", mode = "w", encoding  = "UTF-8") as failed_txt:
        for item in failed_list:
            failed_txt.write(f'{item}\n')


### Starting Process

# Get all sample ID, stored in ID_list
with open(fileID_path, mode = "r", encoding = "UTF-8") as IDtxt:
    for line in IDtxt:
        line = line.strip()

        """
        # Skip if file report exists
        if os.path.isfile(f'{VT_folder_path_Bazaar}{line}.json'):
            # print(f'Skipping file {line}')
            # print(f'==============================\n')
            None
        else:
            ID_list.append(line)
        """
        ID_list.append(line)
            
print(ID_list)

# Get virustotal reports, stored in E:\no6\Reports
main(ID_list)



